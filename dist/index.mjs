function R(s,e,t=[]){let r=["nsfw","porn","hentai","sexy","lewd","adult","xxx","18+","nude"],i=`${s} ${e} ${t.join(" ")}`.toLowerCase();return r.some(n=>i.includes(n))}function v(s){if(s.nsfw)return!0;let e=["nsfw","gonewild","rule34","hentai","porn"];return s.subreddit&&e.some(t=>s.subreddit?.toLowerCase().includes(t))?!0:R(s.title,s.url)}var d=class{static apply(e,t){return e.filter(r=>!(t.nsfw===!1&&(r.nsfw||v(r))||t.minUpvotes&&r.upvotes<t.minUpvotes||t.mediaType&&t.mediaType!=="any"&&r.mediaType!==t.mediaType||t.subreddits&&t.subreddits.length>0&&r.subreddit&&!t.subreddits.map(i=>i.toLowerCase()).includes(r.subreddit.toLowerCase())))}static paginate(e,t){return!t||t<=0?e:e.slice(0,t)}};var h=class{store=new Map;defaultTTL;constructor(e=3600){this.defaultTTL=e*1e3}set(e,t,r){let i=r!==void 0?r*1e3:this.defaultTTL;this.store.set(e,{data:t,expiry:Date.now()+i})}get(e){let t=this.store.get(e);return t?Date.now()>t.expiry?(this.store.delete(e),null):t.data:null}delete(e){this.store.delete(e)}clear(){this.store.clear()}prune(){let e=Date.now();for(let[t,r]of this.store.entries())e>r.expiry&&this.store.delete(t)}},f=new h;import{createHash as _}from"crypto";function T(s){return _("sha256").update(s).digest("hex")}function q(s,e){try{let t=new URL(s),r=new URL(e);return t.hostname.replace("i.","")===r.hostname.replace("i.","")&&t.pathname===r.pathname}catch{return s===e}}var g=class{sources=new Map;registerSource(e){this.sources.set(e.name,e)}async fetch(e){let t=e.source||"reddit",r=this.sources.get(t);if(!r)throw new Error(`Source handler for '${t}' not found`);let i=T(`${t}-${JSON.stringify(e)}`);if(e.cache!==!1){let o=f.get(i);if(o)return o}let n=await r.fetch(e);return n=d.apply(n,e),n=d.paginate(n,e.limit),e.cache!==!1&&f.set(i,n),n}},w=new g;import F from"axios";var L="MemeForge/1.0.0 (https://github.com/PhoenixUchiha/Meme-Forge)",M=class{client;constructor(e){this.client=F.create({baseURL:e,headers:{"User-Agent":L},timeout:1e4})}async get(e,t,r=3){try{return(await this.client.get(e,t)).data}catch(i){if(r>0&&this.isRetryable(i))return await this.delay(1e3*(4-r)),this.get(e,t,r-1);throw this.normalizeError(i)}}isRetryable(e){return e.response?.status===429||e.response?.status>=500||!e.response}delay(e){return new Promise(t=>setTimeout(t,e))}normalizeError(e){return e.response?new Error(`Request failed with status ${e.response.status}: ${JSON.stringify(e.response.data)}`):e}},S=new M;var x=class{lastRequestTime=new Map;minInterval;constructor(e=2){this.minInterval=1e3/e}async throttle(e){let t=Date.now(),r=this.lastRequestTime.get(e)||0,i=t-r;if(i<this.minInterval){let n=this.minInterval-i;await new Promise(o=>setTimeout(o,n))}this.lastRequestTime.set(e,Date.now())}},I=new x;var E=["yo_elvr","LatinoPeopleTwitter","MAAU","orslokx","DylanteroYT","Mujico","PeruMemes","PERU","espanol","MemesMexicanos"],D=["memes","dankmemes","me_irl","wholesomememes","meirl","ProgrammerHumor","funny","meme"],m=class{name="reddit";recentMemeIds=new Set;maxRecentIds=500;async fetch(e){let t;e.subreddits&&e.subreddits.length>0?t=e.subreddits:e.language==="es"?t=E:e.language==="en"?t=D:t=[...E,...D];let r=[...t].sort(()=>Math.random()-.5),i=r.slice(0,Math.min(3,r.length)),n=[];for(let a of i){await I.throttle("reddit");let c=["hot","top"],y=c[Math.floor(Math.random()*c.length)],$=`https://www.reddit.com/r/${a}/${y}.json?limit=50${y==="top"?"&t=day":""}`;try{let u=await S.get($);if(u?.data?.children){let P=u.data.children.map(p=>this.mapToMeme(p.data)).filter(p=>p!==null);n.push(...P)}}catch(u){u.message?.includes("404")||u.message?.includes("banned")}}let o=[];for(let a of n)if(!this.recentMemeIds.has(a.id)&&(o.push(a),this.recentMemeIds.add(a.id),this.recentMemeIds.size>this.maxRecentIds)){let c=this.recentMemeIds.values().next().value;c&&this.recentMemeIds.delete(c)}return o.sort(()=>Math.random()-.5)}mapToMeme(e){if(!e.url||e.is_self)return null;let t=e.url,r=!1;e.is_video&&e.media?.reddit_video?.fallback_url&&(t=e.media.reddit_video.fallback_url,r=!0);let i=r?"video":this.getMediaType(t);return i?{id:e.id,title:e.title,url:t,sourceUrl:`https://reddit.com${e.permalink}`,author:e.author,subreddit:e.subreddit,upvotes:e.ups,nsfw:e.over_18,spoiler:e.spoiler,mediaType:i,createdAt:e.created_utc*1e3,width:e.media?.reddit_video?.width||e.preview?.images?.[0]?.source?.width,height:e.media?.reddit_video?.height||e.preview?.images?.[0]?.source?.height,source:"reddit"}:null}getMediaType(e){return e.match(/\.(jpg|jpeg|png|webp)/i)?"image":e.match(/\.(gif|gifv)/i)?"gif":e.includes("v.redd.it")||e.match(/\.(mp4|webm|mov)/i)?"video":null}};var l=class{static toEmbed(e){return{title:this.truncate(e.title,256),url:e.sourceUrl,image:{url:e.url},color:16729344,author:{name:`u/${e.author}${e.subreddit?` (r/${e.subreddit})`:""}`,url:`https://reddit.com/u/${e.author}`},footer:{text:`\u{1F44D} ${e.upvotes.toLocaleString()} \u2022 Source: ${e.source}`},timestamp:new Date(e.createdAt).toISOString()}}static truncate(e,t){return e.length>t?e.substring(0,t-3)+"...":e}};var b=class{constructor(){this.registerSource(new m)}registerSource(e){w.registerSource(e)}async fetch(e={}){let t=await w.fetch(e);return e.format==="discord-embed"?t.map(r=>l.toEmbed(r)):t}async fetchOne(e={}){let t=await this.fetch({...e,limit:1});return t.length>0?t[0]:null}},ie=new b;export{h as Cache,l as DiscordFormatter,g as Fetcher,d as Filter,M as HttpClient,b as MemeForge,x as RateLimiter,m as RedditSource,f as cache,w as fetcher,T as generateHash,v as hasNSFWContent,S as http,q as isDuplicate,R as isNSFW,ie as memeForge,I as rateLimiter};
//# sourceMappingURL=index.mjs.map