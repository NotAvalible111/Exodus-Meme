"use strict";var $=Object.create;var p=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var O=(s,e)=>{for(var t in e)p(s,t,{get:e[t],enumerable:!0})},S=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of R(e))!F.call(s,n)&&n!==t&&p(s,n,{get:()=>e[n],enumerable:!(r=D(e,n))||r.enumerable});return s};var W=(s,e,t)=>(t=s!=null?$(L(s)):{},S(e||!s||!s.__esModule?p(t,"default",{value:s,enumerable:!0}):t,s)),P=s=>S(p({},"__esModule",{value:!0}),s);var _={};O(_,{Cache:()=>d,DiscordFormatter:()=>l,Fetcher:()=>f,Filter:()=>u,HttpClient:()=>w,MemeForge:()=>y,MultiAPISource:()=>m,RateLimiter:()=>T,cache:()=>h,fetcher:()=>g,generateHash:()=>b,hasNSFWContent:()=>x,http:()=>M,isDuplicate:()=>k,isNSFW:()=>I,memeForge:()=>U,rateLimiter:()=>v});module.exports=P(_);function I(s,e,t=[]){let r=["nsfw","porn","hentai","sexy","lewd","adult","xxx","18+","nude"],n=`${s} ${e} ${t.join(" ")}`.toLowerCase();return r.some(i=>n.includes(i))}function x(s){if(s.nsfw)return!0;let e=["nsfw","gonewild","rule34","hentai","porn"];return s.subreddit&&e.some(t=>s.subreddit?.toLowerCase().includes(t))?!0:I(s.title,s.url)}var u=class{static apply(e,t){return e.filter(r=>!(t.nsfw===!1&&(r.nsfw||x(r))||t.minUpvotes&&r.upvotes<t.minUpvotes||t.mediaType&&t.mediaType!=="any"&&r.mediaType!==t.mediaType||t.subreddits&&t.subreddits.length>0&&r.subreddit&&!t.subreddits.map(n=>n.toLowerCase()).includes(r.subreddit.toLowerCase())))}static paginate(e,t){return!t||t<=0?e:e.slice(0,t)}};var d=class{store=new Map;defaultTTL;constructor(e=3600){this.defaultTTL=e*1e3}set(e,t,r){let n=r!==void 0?r*1e3:this.defaultTTL;this.store.set(e,{data:t,expiry:Date.now()+n})}get(e){let t=this.store.get(e);return t?Date.now()>t.expiry?(this.store.delete(e),null):t.data:null}delete(e){this.store.delete(e)}clear(){this.store.clear()}prune(){let e=Date.now();for(let[t,r]of this.store.entries())e>r.expiry&&this.store.delete(t)}},h=new d;function b(s){let e=0;for(let t=0;t<s.length;t++){let r=s.charCodeAt(t);e=(e<<5)-e+r,e=e&e}return Math.abs(e).toString(36)}function k(s,e){try{let t=new URL(s),r=new URL(e);return t.hostname.replace("i.","")===r.hostname.replace("i.","")&&t.pathname===r.pathname}catch{return s===e}}var f=class{sources=new Map;registerSource(e){this.sources.set(e.name,e)}async fetch(e){let t=e.source||"reddit",r=this.sources.get(t);if(!r)throw new Error(`Source handler for '${t}' not found`);let n=b(`${t}-${JSON.stringify(e)}`);if(e.cache!==!1){let o=h.get(n);if(o)return o}let i=await r.fetch(e);return i=u.apply(i,e),i=u.paginate(i,e.limit),e.cache!==!1&&h.set(n,i),i}},g=new f;var C=W(require("axios")),E=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15"];function N(){return E[Math.floor(Math.random()*E.length)]}var w=class{client;constructor(e){this.client=C.default.create({baseURL:e,timeout:15e3,validateStatus:t=>t<500})}async get(e,t,r=3){let n={"User-Agent":N(),Accept:"application/json","Accept-Language":"en-US,en;q=0.9,es;q=0.8","Accept-Encoding":"gzip, deflate, br","Cache-Control":"no-cache",Pragma:"no-cache","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin",...t?.headers};try{let i=await this.client.get(e,{...t,headers:n});if(i.status===404||i.status===403||i.status===429)throw new Error(`Request failed with status ${i.status}`);return i.data}catch(i){if(r>0&&this.isRetryable(i)){let o=(4-r)*3e3;return await this.delay(o),this.get(e,t,r-1)}throw this.normalizeError(i)}}isRetryable(e){return e.response?.status===429||e.response?.status===503||e.response?.status>=500||e.code==="ECONNRESET"||e.code==="ETIMEDOUT"||e.code==="ECONNREFUSED"||!e.response}delay(e){return new Promise(t=>setTimeout(t,e))}normalizeError(e){return e.response?new Error(`Request failed with status ${e.response.status}: ${JSON.stringify(e.response.data)}`):e.code?new Error(`Network error: ${e.code} - ${e.message}`):e}},M=new w;var T=class{lastRequestTime=new Map;minInterval;constructor(e=.5){this.minInterval=1e3/e}async throttle(e){let t=Date.now(),r=this.lastRequestTime.get(e)||0,n=t-r;if(n<this.minInterval){let i=this.minInterval-n;await new Promise(o=>setTimeout(o,i))}this.lastRequestTime.set(e,Date.now())}},v=new T;var m=class{name="multiapi";recentMemeIds=new Set;maxRecentIds=150;memeCache=[];lastFetchTime=0;cacheDuration=18e4;async fetch(e){let t=Date.now();if(this.memeCache.length>10&&t-this.lastFetchTime<this.cacheDuration)return[...this.memeCache].sort(()=>Math.random()-.5).slice(0,e.limit||20);await v.throttle("multiapi");let r=[{url:"https://api.want.cat/api/memes",type:"want",count:1},{url:"https://meme-api.com/gimme/MAAU/20",type:"reddit",count:20},{url:"https://meme-api.com/gimme/yo_elvr/20",type:"reddit",count:20},{url:"https://meme-api.com/gimme/LatinoPeopleTwitter/20",type:"reddit",count:20}],n=[];for(let i of r)try{if(i.type==="want")for(let o=0;o<20;o++){let c=await M.get(i.url,{timeout:8e3});if(c?.url){let a=this.mapWantCatToMeme(c,o);a&&n.push(a)}await new Promise(a=>setTimeout(a,200))}else if(i.type==="reddit"){let o=await M.get(i.url,{timeout:1e4});if(o?.memes&&Array.isArray(o.memes)){let c=o.memes.map((a,A)=>this.mapRedditAPIToMeme(a,A)).filter(a=>a!==null);n.push(...c)}}}catch(o){console.error(`Error fetching from ${i.url}:`,o.message);continue}if(n.length>0){this.memeCache=n,this.lastFetchTime=t;let i=[];for(let o of n)if(!this.recentMemeIds.has(o.id)&&(i.push(o),this.recentMemeIds.add(o.id),this.recentMemeIds.size>this.maxRecentIds)){let c=this.recentMemeIds.values().next().value;c&&this.recentMemeIds.delete(c)}return i.sort(()=>Math.random()-.5)}return this.memeCache.length>0?[...this.memeCache].sort(()=>Math.random()-.5).slice(0,e.limit||20):[]}mapWantCatToMeme(e,t){return e.url?{id:`want_${Date.now()}_${t}_${e.url.split("/").pop()}`,title:e.title||"Meme",url:e.url,sourceUrl:"https://want.cat",author:"want.cat",upvotes:0,nsfw:!1,spoiler:!1,mediaType:"image",createdAt:Date.now(),source:"want"}:null}mapRedditAPIToMeme(e,t){if(!e.url||e.nsfw)return null;let r=this.getMediaType(e.url);return!r||r==="video"?null:{id:e.postLink?e.postLink.split("/").pop()||`meme_${Date.now()}_${t}`:`meme_${Date.now()}_${t}`,title:e.title||"Meme",url:e.url,sourceUrl:e.postLink||"https://reddit.com",author:e.author||"unknown",subreddit:e.subreddit,upvotes:e.ups||0,nsfw:e.nsfw||!1,spoiler:e.spoiler||!1,mediaType:r,createdAt:Date.now(),source:"reddit"}}getMediaType(e){return e.match(/\.(jpg|jpeg|png|webp)/i)||e.includes("i.redd.it")?"image":e.match(/\.(gif|gifv)/i)?"gif":e.includes("v.redd.it")||e.match(/\.(mp4|webm|mov)/i)?"video":null}};var l=class{static toEmbed(e){return{title:this.truncate(e.title,256),url:e.sourceUrl,image:{url:e.url},color:16729344,author:{name:`u/${e.author}${e.subreddit?` (r/${e.subreddit})`:""}`,url:`https://reddit.com/u/${e.author}`},footer:{text:`\u{1F44D} ${e.upvotes.toLocaleString()} \u2022 Source: ${e.source}`},timestamp:new Date(e.createdAt).toISOString()}}static truncate(e,t){return e.length>t?e.substring(0,t-3)+"...":e}};var y=class{constructor(){this.registerSource(new m)}registerSource(e){g.registerSource(e)}async fetch(e={}){e.source||(e.source="multiapi");let t=await g.fetch(e);return e.format==="discord-embed"?t.map(r=>l.toEmbed(r)):t}async fetchOne(e={}){let t=await this.fetch({...e,limit:1});return t.length>0?t[0]:null}},U=new y;0&&(module.exports={Cache,DiscordFormatter,Fetcher,Filter,HttpClient,MemeForge,MultiAPISource,RateLimiter,cache,fetcher,generateHash,hasNSFWContent,http,isDuplicate,isNSFW,memeForge,rateLimiter});
//# sourceMappingURL=index.js.map