"use strict";var A=Object.create;var p=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,C=Object.prototype.hasOwnProperty;var q=(s,e)=>{for(var t in e)p(s,t,{get:e[t],enumerable:!0})},D=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of O(e))!C.call(s,i)&&i!==t&&p(s,i,{get:()=>e[i],enumerable:!(r=H(e,i))||r.enumerable});return s};var j=(s,e,t)=>(t=s!=null?A(N(s)):{},D(e||!s||!s.__esModule?p(t,"default",{value:s,enumerable:!0}):t,s)),k=s=>D(p({},"__esModule",{value:!0}),s);var G={};q(G,{Cache:()=>h,DiscordFormatter:()=>l,Fetcher:()=>g,Filter:()=>a,HttpClient:()=>M,MemeForge:()=>b,RateLimiter:()=>x,RedditSource:()=>m,cache:()=>f,fetcher:()=>w,generateHash:()=>T,hasNSFWContent:()=>v,http:()=>S,isDuplicate:()=>z,isNSFW:()=>$,memeForge:()=>B,rateLimiter:()=>I});module.exports=k(G);function $(s,e,t=[]){let r=["nsfw","porn","hentai","sexy","lewd","adult","xxx","18+","nude"],i=`${s} ${e} ${t.join(" ")}`.toLowerCase();return r.some(n=>i.includes(n))}function v(s){if(s.nsfw)return!0;let e=["nsfw","gonewild","rule34","hentai","porn"];return s.subreddit&&e.some(t=>s.subreddit?.toLowerCase().includes(t))?!0:$(s.title,s.url)}var a=class{static apply(e,t){return e.filter(r=>!(t.nsfw===!1&&(r.nsfw||v(r))||t.minUpvotes&&r.upvotes<t.minUpvotes||t.mediaType&&t.mediaType!=="any"&&r.mediaType!==t.mediaType||t.subreddits&&t.subreddits.length>0&&r.subreddit&&!t.subreddits.map(i=>i.toLowerCase()).includes(r.subreddit.toLowerCase())))}static paginate(e,t){return!t||t<=0?e:e.slice(0,t)}};var h=class{store=new Map;defaultTTL;constructor(e=3600){this.defaultTTL=e*1e3}set(e,t,r){let i=r!==void 0?r*1e3:this.defaultTTL;this.store.set(e,{data:t,expiry:Date.now()+i})}get(e){let t=this.store.get(e);return t?Date.now()>t.expiry?(this.store.delete(e),null):t.data:null}delete(e){this.store.delete(e)}clear(){this.store.clear()}prune(){let e=Date.now();for(let[t,r]of this.store.entries())e>r.expiry&&this.store.delete(t)}},f=new h;var P=require("crypto");function T(s){return(0,P.createHash)("sha256").update(s).digest("hex")}function z(s,e){try{let t=new URL(s),r=new URL(e);return t.hostname.replace("i.","")===r.hostname.replace("i.","")&&t.pathname===r.pathname}catch{return s===e}}var g=class{sources=new Map;registerSource(e){this.sources.set(e.name,e)}async fetch(e){let t=e.source||"reddit",r=this.sources.get(t);if(!r)throw new Error(`Source handler for '${t}' not found`);let i=T(`${t}-${JSON.stringify(e)}`);if(e.cache!==!1){let o=f.get(i);if(o)return o}let n=await r.fetch(e);return n=a.apply(n,e),n=a.paginate(n,e.limit),e.cache!==!1&&f.set(i,n),n}},w=new g;var R=j(require("axios")),W="MemeForge/1.0.0 (https://github.com/PhoenixUchiha/Meme-Forge)",M=class{client;constructor(e){this.client=R.default.create({baseURL:e,headers:{"User-Agent":W},timeout:1e4})}async get(e,t,r=3){try{return(await this.client.get(e,t)).data}catch(i){if(r>0&&this.isRetryable(i))return await this.delay(1e3*(4-r)),this.get(e,t,r-1);throw this.normalizeError(i)}}isRetryable(e){return e.response?.status===429||e.response?.status>=500||!e.response}delay(e){return new Promise(t=>setTimeout(t,e))}normalizeError(e){return e.response?new Error(`Request failed with status ${e.response.status}: ${JSON.stringify(e.response.data)}`):e}},S=new M;var x=class{lastRequestTime=new Map;minInterval;constructor(e=2){this.minInterval=1e3/e}async throttle(e){let t=Date.now(),r=this.lastRequestTime.get(e)||0,i=t-r;if(i<this.minInterval){let n=this.minInterval-i;await new Promise(o=>setTimeout(o,n))}this.lastRequestTime.set(e,Date.now())}},I=new x;var _=["yo_elvr","LatinoPeopleTwitter","MAAU","orslokx","DylanteroYT","Mujico","PeruMemes","PERU","espanol","MemesMexicanos"],F=["memes","dankmemes","me_irl","wholesomememes","meirl","ProgrammerHumor","funny","meme"],m=class{name="reddit";recentMemeIds=new Set;maxRecentIds=500;async fetch(e){let t;e.subreddits&&e.subreddits.length>0?t=e.subreddits:e.language==="es"?t=_:e.language==="en"?t=F:t=[..._,...F];let r=[...t].sort(()=>Math.random()-.5),i=r.slice(0,Math.min(3,r.length)),n=[];for(let c of i){await I.throttle("reddit");let u=["hot","top"],E=u[Math.floor(Math.random()*u.length)],L=`https://www.reddit.com/r/${c}/${E}.json?limit=50${E==="top"?"&t=day":""}`;try{let d=await S.get(L);if(d?.data?.children){let U=d.data.children.map(y=>this.mapToMeme(y.data)).filter(y=>y!==null);n.push(...U)}}catch(d){d.message?.includes("404")||d.message?.includes("banned")}}let o=[];for(let c of n)if(!this.recentMemeIds.has(c.id)&&(o.push(c),this.recentMemeIds.add(c.id),this.recentMemeIds.size>this.maxRecentIds)){let u=this.recentMemeIds.values().next().value;u&&this.recentMemeIds.delete(u)}return o.sort(()=>Math.random()-.5)}mapToMeme(e){if(!e.url||e.is_self)return null;let t=e.url,r=!1;e.is_video&&e.media?.reddit_video?.fallback_url&&(t=e.media.reddit_video.fallback_url,r=!0);let i=r?"video":this.getMediaType(t);return i?{id:e.id,title:e.title,url:t,sourceUrl:`https://reddit.com${e.permalink}`,author:e.author,subreddit:e.subreddit,upvotes:e.ups,nsfw:e.over_18,spoiler:e.spoiler,mediaType:i,createdAt:e.created_utc*1e3,width:e.media?.reddit_video?.width||e.preview?.images?.[0]?.source?.width,height:e.media?.reddit_video?.height||e.preview?.images?.[0]?.source?.height,source:"reddit"}:null}getMediaType(e){return e.match(/\.(jpg|jpeg|png|webp)/i)?"image":e.match(/\.(gif|gifv)/i)?"gif":e.includes("v.redd.it")||e.match(/\.(mp4|webm|mov)/i)?"video":null}};var l=class{static toEmbed(e){return{title:this.truncate(e.title,256),url:e.sourceUrl,image:{url:e.url},color:16729344,author:{name:`u/${e.author}${e.subreddit?` (r/${e.subreddit})`:""}`,url:`https://reddit.com/u/${e.author}`},footer:{text:`\u{1F44D} ${e.upvotes.toLocaleString()} \u2022 Source: ${e.source}`},timestamp:new Date(e.createdAt).toISOString()}}static truncate(e,t){return e.length>t?e.substring(0,t-3)+"...":e}};var b=class{constructor(){this.registerSource(new m)}registerSource(e){w.registerSource(e)}async fetch(e={}){let t=await w.fetch(e);return e.format==="discord-embed"?t.map(r=>l.toEmbed(r)):t}async fetchOne(e={}){let t=await this.fetch({...e,limit:1});return t.length>0?t[0]:null}},B=new b;0&&(module.exports={Cache,DiscordFormatter,Fetcher,Filter,HttpClient,MemeForge,RateLimiter,RedditSource,cache,fetcher,generateHash,hasNSFWContent,http,isDuplicate,isNSFW,memeForge,rateLimiter});
//# sourceMappingURL=index.js.map